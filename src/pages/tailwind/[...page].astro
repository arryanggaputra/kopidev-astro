---
import { getCollection, type CollectionEntry } from "astro:content";
import TailwindComponentsLayout from "../../components/TailwindComponentsLayout.astro";
import type { GetStaticPaths } from 'astro';
import { SITE_CONFIG } from "~/config/site";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  // Get all tailwind components
  let tailwindComponents: CollectionEntry<'tailwind-components'>[];
  try {
    tailwindComponents = await getCollection('tailwind-components');
  } catch (error) {
    console.error('Error loading tailwind components:', error);
    tailwindComponents = [];
  }

  // Sort by date (newest first)
  const sortedComponents = tailwindComponents
    .filter((component): component is CollectionEntry<'tailwind-components'> => Boolean(component && component.data))
    .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

  return paginate(sortedComponents, { pageSize: 24 });
};

const { page } = Astro.props;

// Build canonical URL
const canonicalUrl = `${SITE_CONFIG.url}/tailwind/${page.currentPage > 1 ? page.currentPage + '/' : ''}`;

// Build title and description
const pageTitle = page.currentPage === 1 
  ? "Tailwind Components & Templates"
  : `Tailwind Components & Templates - Page ${page.currentPage}`;

const pageDescription = page.currentPage === 1
  ? "Free collection of 600+ Tailwind CSS components and templates. Copy-paste ready UI elements, forms, cards, navigation, and more for your next web project."
  : `Page ${page.currentPage} of Tailwind CSS components - showing ${(page.currentPage - 1) * 24 + 1}-${Math.min(page.currentPage * 24, page.total)} of ${page.total} components`;

// Get all components for category counts (not paginated)
let allComponents: CollectionEntry<'tailwind-components'>[];
try {
  allComponents = await getCollection('tailwind-components');
} catch (error) {
  console.error('Error loading tailwind components:', error);
  allComponents = [];
}

// Group by categories to get category counts
const categoryGroups = new Map<string, number>();
allComponents.forEach(component => {
  if (component.data.categories) {
    component.data.categories.forEach(category => {
      categoryGroups.set(category, (categoryGroups.get(category) || 0) + 1);
    });
  }
});

const categories = Array.from(categoryGroups.entries()).map(([name, total]) => ({ name, total }));
---

<TailwindComponentsLayout
  title={pageTitle}
  description={pageDescription}
  page={page}
  allComponents={allComponents}
  categories={categories}
  canonical={canonicalUrl}
/>