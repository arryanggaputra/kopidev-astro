---
import { getCollection, type CollectionEntry } from "astro:content";
import TailwindComponentsLayout from "../../../../components/TailwindComponentsLayout.astro";
import type { GetStaticPaths } from 'astro';
import { SITE_CONFIG } from "~/config/site";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  // Get all tailwind components
  const tailwindComponents = await getCollection('tailwind-components');
  
  // Get all unique categories
  const categories = new Set<string>();
  tailwindComponents.forEach(component => {
    if (component.data.categories) {
      component.data.categories.forEach(category => {
        categories.add(category);
      });
    }
  });

  // Generate paginated paths for each category
  const allPaths = [];
  
  for (const category of categories) {
    // Filter components for this category
    const filteredComponents = tailwindComponents
      .filter((component): component is CollectionEntry<'tailwind-components'> => {
        return Boolean(component && component.data && component.data.categories?.includes(category));
      })
      .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

    // Generate paginated paths for this category
    const categoryPaths = paginate(filteredComponents, {
      params: { category },
      pageSize: 24,
    });

    allPaths.push(...categoryPaths);
  }

  return allPaths;
};

const { page } = Astro.props;
const { category } = Astro.params;

// Ensure category is a string
const categoryName = category as string;
const categoryTitle = categoryName.charAt(0).toUpperCase() + categoryName.slice(1);

// Build canonical URL
const canonicalUrl = `${SITE_CONFIG.url}/tailwind/category/${categoryName}/${page.currentPage > 1 ? page.currentPage + '/' : ''}`;

// Build description
const pageDescription = page.currentPage === 1
  ? `Browse ${page.total} free ${categoryTitle} Tailwind CSS components. Copy-paste ready UI elements for your next project.`
  : `Page ${page.currentPage} of ${categoryTitle} Tailwind CSS components - showing ${(page.currentPage - 1) * 24 + 1}-${Math.min(page.currentPage * 24, page.total)} of ${page.total} components`;

// Get all components for category counts (not paginated)
let allComponents: CollectionEntry<'tailwind-components'>[];
try {
  allComponents = await getCollection('tailwind-components');
} catch (error) {
  console.error('Error loading tailwind components:', error);
  allComponents = [];
}

// Get all categories for sidebar
const categoryGroups = new Map<string, number>();
allComponents.forEach(component => {
  if (component.data.categories) {
    component.data.categories.forEach(cat => {
      categoryGroups.set(cat, (categoryGroups.get(cat) || 0) + 1);
    });
  }
});

const allCategories = Array.from(categoryGroups.entries()).map(([name, total]) => ({ name, total }));
---

<TailwindComponentsLayout
  title={`${categoryTitle} Tailwind Components${page.currentPage > 1 ? ` - Page ${page.currentPage}` : ''}`}
  description={pageDescription}
  breadcrumbs={[
    { name: "Tailwind Components", href: "/tailwind/" },
    { name: categoryTitle }
  ]}
  page={page}
  allComponents={allComponents}
  categories={allCategories}
  currentCategory={categoryName}
  canonical={canonicalUrl}
/>
