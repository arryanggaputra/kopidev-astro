---
import dayjs from "dayjs";
import { getCollection, getEntry, type CollectionEntry } from "astro:content";
import Layout from "../layouts/Layout.astro";
import TableOfContents from "~/components/TableOfContents.astro";
import TagButton from "~/components/TagButton.astro";

export async function getStaticPaths() {
  const blogs = await getCollection("blog");
  const headings = await Promise.all(
    blogs.map(async (post: CollectionEntry<'blog'>) => {
      const data = await post.render();
      return data.headings;
    })
  );

  return blogs.map((blog, index: number) => ({
    params: { slug: blog.slug },
    props: { ...blog, headings: headings[index] },
  }));
}

const { slug, headings } = Astro.props;

const entry = await getEntry("blog", slug);
if (!entry) {
  return Astro.redirect('/404');
}

const { Content } = await entry.render();

// Get all categories for title lookup
const categories = await getCollection('categories');
const categoryMap = new Map<string, string>();
categories.forEach(cat => {
  categoryMap.set(cat.slug, cat.data.title);
});
---

<Layout title={entry.data.title}>
  <div class="container max-w-3xl mx-auto px-5 lg:px-0 py-5 text-left">
    <div class="py-5 border-b mb-5 border-[#222]">
      <h1 class="text-3xl font-bold">
        <a>
          {entry.data.title}
        </a>
      </h1>
      <div class="text-xs md:text-sm text-gray-400 pt-5">
        ðŸ—“ Published at : {dayjs(entry.data.date).format("MMMM D, YYYY")}
      </div>
    </div>
    <div class="flex flex-row flex-wrap gap-2">
      {entry.data.categories?.map((category: string) => {
        const categoryTitle = categoryMap.get(category) || category;
        return (
          <TagButton href={`/category/${category}`} title={categoryTitle}>
            {categoryTitle}
          </TagButton>
        )
      })}
    </div>
    <div class="prose">
      <TableOfContents headings={headings} />
      <Content />
    </div>
  </div>
</Layout>
