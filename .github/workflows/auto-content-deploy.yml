name: ğŸ¤– Auto Content Generation & Deploy

on:
  push:
    branches: [main]
  schedule:
    # Run twice daily at 6 AM and 6 PM UTC
    - cron: "0 6,18 * * *"
  workflow_dispatch:
    inputs:
      max_components:
        description: "Max components to generate"
        required: false
        default: "2"
      force_generation:
        description: "Force generation even if recent commit"
        type: boolean
        required: false
        default: false

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ENABLE_AUTO_GENERATION: true
  MAX_COMPONENTS_PER_BUILD: ${{ github.event.inputs.max_components || '2' }}
  SKIP_IF_RECENT_COMMIT: ${{ github.event.inputs.force_generation != 'true' }}

jobs:
  generate-and-deploy:
    name: ğŸš€ Generate Content & Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need history to check last commit
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Check Last Commit
        id: check_commit
        run: |
          LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "last_commit_msg=$LAST_COMMIT_MSG" >> $GITHUB_OUTPUT

          if [[ "$LAST_COMMIT_MSG" == *"ğŸ¤–"* ]] && [[ "${{ github.event.inputs.force_generation }}" != "true" ]] && [[ "${{ github.event_name }}" != "schedule" ]]; then
            echo "skip_generation=true" >> $GITHUB_OUTPUT
            echo "â­ï¸ Last commit was auto-generated, skipping generation"
          else
            echo "skip_generation=false" >> $GITHUB_OUTPUT
            echo "âœ… Proceeding with generation"
          fi

      - name: ğŸ”§ Setup Node.js
        if: steps.check_commit.outputs.skip_generation == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        if: steps.check_commit.outputs.skip_generation == 'false'
        run: npm ci

      - name: ğŸ¤– Generate New Content
        if: steps.check_commit.outputs.skip_generation == 'false'
        run: |
          echo "ğŸš€ Starting automatic content generation..."
          npm run generate:content || echo "âš ï¸ Content generation had some issues, continuing..."

      - name: ğŸ“¸ Generate Screenshots
        if: steps.check_commit.outputs.skip_generation == 'false'
        run: |
          echo "ğŸ“¸ Generating screenshots for all components..."
          npm run generate:screenshots || echo "âš ï¸ Screenshot generation had some issues, continuing..."

      - name: ğŸ“¤ Commit Generated Content
        if: steps.check_commit.outputs.skip_generation == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          # Check if there are any changes
          if git diff --quiet && git diff --staged --quiet; then
            echo "ğŸ“ No changes to commit"
          else
            git add -A
            git commit -m "ğŸ¤– Auto-generate Tailwind components with AI
            
            - Generated $(find src/content/tailwind-components/auto-generated -name '*.mdx' -newer .git/COMMIT_EDITMSG 2>/dev/null | wc -l) new components
            - Updated screenshots
            - Triggered by: ${{ github.event_name }}
            
            Generated at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
            " || echo "ğŸ“ Nothing new to commit"
            
            git push origin main || echo "âš ï¸ Push failed, might be handled by deployment"
          fi

      - name: ğŸ—ï¸ Build Site
        run: npm run build

      - name: ğŸš€ Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: kopidev-astro
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    name: ğŸ§¹ Cleanup Old Auto-Generated Components
    runs-on: ubuntu-latest
    needs: generate-and-deploy
    if: github.event_name == 'schedule'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ—‘ï¸ Remove Old Components
        run: |
          echo "ğŸ§¹ Cleaning up auto-generated components older than 30 days..."
          find src/content/tailwind-components/auto-generated -name "*.mdx" -type f -mtime +30 -delete || true
          find src/content/tailwind-components/auto-generated -empty -type d -delete || true

          # Commit cleanup if there are changes
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

          if ! git diff --quiet; then
            git add -A
            git commit -m "ğŸ§¹ Cleanup old auto-generated components" || true
            git push origin main || true
          fi
