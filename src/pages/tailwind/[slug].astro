---
import { getCollection, getEntry, type CollectionEntry } from "astro:content";
import { Image } from "astro:assets";
import Layout from "../../layouts/Layout.astro";
import HorizontalAd from "../../components/Ads/horizontal.astro";
import { readFileSync, existsSync } from "fs";
import { join } from "path";

export async function getStaticPaths() {
  const tailwindComponents = await getCollection("tailwind-components");
  
  return tailwindComponents.map((component) => ({
    params: { slug: component.data.slug || component.slug },
    props: { component },
  }));
}

interface Props {
  component: CollectionEntry<'tailwind-components'>;
}

const { component } = Astro.props;
const { Content } = await component.render();

// Get the slug from either frontmatter or file path
const componentSlug = component.data.slug || component.slug;

// Read the HTML code file
let htmlCode = '';

try {
  // Remove the '/index.mdx' part from the component ID to get the correct directory path
  const componentDir = component.id.replace('/index.mdx', '');
  
  // Try multiple possible paths
  const possiblePaths = [
    join(process.cwd(), 'src', 'content', 'tailwind-components', componentDir, 'code', 'index.html'),
    join(process.cwd(), 'src', 'content', 'tailwind-components', component.slug, 'code', 'index.html'),
  ];
  
  for (const path of possiblePaths) {
    if (existsSync(path)) {
      htmlCode = readFileSync(path, 'utf-8');
      break;
    }
  }
} catch (error) {
  console.error('Error reading HTML code file:', error);
}
---

<Layout title={component.data.title} fullWidth={true}>
  <!-- Ad Section -->
  <div class="bg-black text-white">
    <div class="w-full px-5 py-4">
      <div class="flex justify-center">
        <HorizontalAd />
      </div>
    </div>
  </div>

  <!-- Header Section -->
  <div class="bg-black text-white p-8">
    <div class="w-full">
      <div class="flex flex-col md:flex-row justify-between gap-6">
        <div class="flex flex-row gap-4 flex-1">
          <div class="hidden md:block">
            {component.data.coverImage && (
              <Image
                src={component.data.coverImage}
                alt={component.data.title}
                width={160}
                height={120}
                class="w-40 border border-gray-100 rounded"
              />
            )}
          </div>
          <div>
            <h1 class="font-bold text-lg md:text-xl mb-2">
              {component.data.title}
            </h1>
            <div class="prose prose-invert">
              <Content />
            </div>
            {component.data.categories && (
              <div class="flex flex-wrap gap-2 mt-4">
                {component.data.categories.map(category => (
                  <span class="text-xs bg-blue-600 text-white px-2 py-1 rounded capitalize">
                    {category}
                  </span>
                ))}
              </div>
            )}
          </div>
        </div>
        <div class="w-full md:w-32">
          <button
            id="toggleCodeBtn"
            class="w-full text-sm bg-green-700 hover:bg-green-600 px-4 py-2 rounded transition-colors duration-200"
          >
            Show Code
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Code Section (initially hidden) -->
  <div id="codeSection" class="hidden bg-[#011627] text-white">
    <div class="w-full px-5 py-4">
      <!-- Ad Space -->
      <div class="flex justify-center mb-4">
        <HorizontalAd />
      </div>
    </div>
    <div class="overflow-x-auto">
      <div class="bg-[#011627] p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-green-400 font-semibold">HTML Code</h3>
          <button 
            id="copyCodeBtn"
            class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-sm transition-colors duration-200"
          >
            Copy Code
          </button>
        </div>
        <pre class="language-html"><code id="codeContent" class="language-html text-sm">{htmlCode}</code></pre>
      </div>
    </div>
  </div>

  <!-- Preview Section -->
  <div id="previewSection" class="h-screen bg-white w-full relative">
    <div id="loadingIndicator" class="absolute top-0 left-0 bg-black bg-opacity-30 w-full h-full flex items-center justify-center text-white">
      Loading the Tailwind Component...
    </div>
    <iframe
      id="previewIframe"
      class="bg-gray-50 w-full h-full opacity-0 transition-opacity duration-300"
      loading="lazy"
    ></iframe>
  </div>

  <script define:vars={{ htmlCode, title: component.data.title }}>
    let isCodeVisible = false;
    const toggleBtn = document.getElementById('toggleCodeBtn');
    const codeSection = document.getElementById('codeSection');
    const previewIframe = document.getElementById('previewIframe');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const copyCodeBtn = document.getElementById('copyCodeBtn');

    // Toggle code visibility
    toggleBtn?.addEventListener('click', () => {
      isCodeVisible = !isCodeVisible;
      if (codeSection) {
        codeSection.style.display = isCodeVisible ? 'block' : 'none';
      }
      if (toggleBtn) {
        toggleBtn.textContent = isCodeVisible ? 'Hide Code' : 'Show Code';
      }
    });

    // Copy code functionality
    copyCodeBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(htmlCode);
        const originalText = copyCodeBtn.textContent;
        copyCodeBtn.textContent = 'Copied!';
        copyCodeBtn.style.backgroundColor = '#059669'; // green-600
        
        setTimeout(() => {
          copyCodeBtn.textContent = originalText;
          copyCodeBtn.style.backgroundColor = '#16a34a'; // green-600
        }, 2000);
      } catch (err) {
        console.error('Failed to copy code: ', err);
        copyCodeBtn.textContent = 'Copy Failed';
        setTimeout(() => {
          copyCodeBtn.textContent = 'Copy Code';
        }, 2000);
      }
    });

    // Load iframe after a delay
    setTimeout(() => {
      if (previewIframe && htmlCode) {
        const iframeContent = `
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta http-equiv="X-UA-Compatible" content="ie=edge">
            <title>${title}</title>
            <script src="https://unpkg.com/tailwindcss-jit-cdn"><\/script>
            <style>
              body { margin: 0; padding: 0; min-height: 100vh; }
              * { box-sizing: border-box; }
            </style>
          </head>
          <body>
            ${htmlCode}
          </body>
          </html>
        `;
        
        previewIframe.srcdoc = iframeContent;
        
        previewIframe.onload = () => {
          if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
          }
          previewIframe.style.opacity = '1';
        };
      } else {
        if (loadingIndicator) {
          loadingIndicator.innerHTML = 'Failed to load component preview - HTML code not found';
        }
      }
    }, 1000);
  </script>
</Layout>
